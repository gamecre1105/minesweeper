<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>位置表示（精密 & 概略）</title>
<style>
  :root{
    --bg:#0f1220; --panel:#171a2b; --text:#e8ecf3; --muted:#a9b0c3; --accent:#4dd0e1; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 10% -10%, #1e2240, transparent),var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans JP",Meiryo,Arial}
  .wrap{max-width:900px;margin:24px auto;padding:16px;display:grid;gap:16px}
  .card{background:var(--panel);border-radius:14px;padding:14px;box-shadow:0 8px 16px rgba(0,0,0,.25), inset 0 8px 22px rgba(0,0,0,.15)}
  h1{margin:4px 0 0;font-size:clamp(20px,5vw,28px)} h2{margin:.2rem 0 .6rem;font-size:1.05rem;color:#cfd5e7}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .item{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:10px}
  .label{color:var(--muted)}
  .btn{cursor:pointer;border:none;border-radius:10px;padding:9px 12px;font-weight:700;background:linear-gradient(180deg,#2a2f52,#212544);color:var(--text);
    box-shadow:0 6px 18px rgba(0,0,0,.3)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .ok{color:#a5d6a7}.warn{color:#ffcc80}.err{color:var(--danger)}
  pre{white-space:pre-wrap;word-break:break-all}
  .split{display:grid;gap:12px} @media(min-width:820px){.split{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>位置表示ツール（精密 & 概略）</h1>

  <div class="card">
    <h2>環境</h2>
    <div class="row">
      <div class="item"><span class="label">接続</span><span id="https" class="mono">checking…</span></div>
      <div class="item"><span class="label">タイムゾーン</span><span id="tz" class="mono">--</span></div>
      <div class="item"><span class="label">ローカル時刻</span><span id="now" class="mono">--</span></div>
      <div class="item"><span class="label">UA</span><span id="ua" class="mono">--</span></div>
    </div>
    <div id="httpsHint" class="mono" style="margin-top:6px;color:#ffcc80"></div>
  </div>

  <div class="split">
    <div class="card">
      <h2>精密位置（Geolocation API / 要許可）</h2>
      <div class="row" style="gap:8px;margin-bottom:6px">
        <button class="btn" id="btnGeo">現在地を取得</button>
        <button class="btn" id="btnGeoHi">高精度で取得</button>
        <button class="btn" id="btnClear1">表示クリア</button>
      </div>
      <pre id="geoOut" class="mono"></pre>
    </div>

    <div class="card">
      <h2>概略位置（IPベース / 市区町村レベル目安）</h2>
      <div class="row" style="gap:8px;margin-bottom:6px">
        <button class="btn" id="btnIp1">ipapi.co で取得</button>
        <button class="btn" id="btnIp2">ipwho.is で取得</button>
        <button class="btn" id="btnClear2">表示クリア</button>
      </div>
      <pre id="ipOut" class="mono"></pre>
      <div class="mono" style="color:#a9b0c3">
        ※ IP位置は通信事業者の拠点（例: 名古屋）に引っ張られることがあります。実在の居場所とはズレる場合があります。
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ====== 環境表示 ======
  const elHttps = document.getElementById('https');
  const elTz = document.getElementById('tz');
  const elNow = document.getElementById('now');
  const elUA = document.getElementById('ua');
  const elHttpsHint = document.getElementById('httpsHint');

  const isHttps = location.protocol === 'https:' || location.hostname === 'localhost';
  elHttps.textContent = isHttps ? 'HTTPS ✅' : (location.protocol + ' ⚠︎');
  elHttps.className = 'mono ' + (isHttps ? 'ok' : 'warn');
  if(!isHttps){
    elHttpsHint.textContent = 'Geolocation(API)は https または localhost でのみ動作します。GitHub Pages の https で開いてください。';
  }

  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Unknown';
  const offMin = -new Date().getTimezoneOffset(); // JST=+540
  const sign = offMin >= 0 ? '+' : '-';
  const h = String(Math.floor(Math.abs(offMin)/60)).padStart(2,'0');
  const m = String(Math.abs(offMin)%60).padStart(2,'0');
  const utc = `UTC${sign}${h}${m==='00'?'':':'+m}`;
  const abbr = (tz==='Asia/Tokyo') ? 'JST' : utc;
  elTz.textContent = `${abbr} (${utc})`;
  elUA.textContent = navigator.userAgent;

  function tick(){
    elNow.textContent = new Date().toLocaleString();
    requestAnimationFrame(()=>setTimeout(tick,500));
  }
  tick();

  // ====== 精密位置（Geolocation + 逆ジオコーディング） ======
  const geoOut = document.getElementById('geoOut');
  async function reverseGeocode(lat, lng){
    // OpenStreetMap Nominatim（軽く使う前提。大量アクセスは避けてください）
    const url = new URL('https://nominatim.openstreetmap.org/reverse');
    url.searchParams.set('lat', lat);
    url.searchParams.set('lon', lng);
    url.searchParams.set('format', 'jsonv2');
    url.searchParams.set('accept-language', 'ja');
    const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if(!res.ok) throw new Error('reverse geocode failed');
    const j = await res.json();
    const a = j.address || {};
    // 都道府県（state）・市区町村（city/town/village）など
    const prefecture = a.state || a.province || '';
    const city = a.city || a.town || a.village || a.county || '';
    const road = a.road || '';
    const disp = j.display_name || '';
    return {prefecture, city, road, display: disp};
  }

  async function getGeo(highAccuracy=false){
    if(!isHttps){
      geoOut.textContent = '⚠ HTTPSではないため取得できません（localhostは可）。';
      return;
    }
    geoOut.textContent = '取得中…（許可ダイアログが出ることがあります）';
    const opts = { enableHighAccuracy: highAccuracy, timeout: 15000, maximumAge: 60000 };
    navigator.geolocation.getCurrentPosition(async pos=>{
      const { latitude, longitude, accuracy } = pos.coords;
      let line = `精密位置: OK\nlat: ${latitude.toFixed(6)}\nlng: ${longitude.toFixed(6)}\n精度: ±${Math.round(accuracy)} m`;
      try{
        const rev = await reverseGeocode(latitude, longitude);
        line += `\n\n住所(推定): ${rev.prefecture} ${rev.city} ${rev.road}\n詳細: ${rev.display}`;
      }catch(e){
        line += `\n\n住所(推定): 取得失敗`;
      }
      line += `\n取得方法: Geolocation API${highAccuracy?'（高精度）':''}`;
      geoOut.textContent = line;
    }, err=>{
      const map = {1:'PERMISSION_DENIED(拒否)', 2:'POSITION_UNAVAILABLE(取得不能)', 3:'TIMEOUT(時間切れ)'};
      geoOut.textContent = `精密位置: 失敗\ncode: ${err.code} ${map[err.code]||''}\nmsg: ${err.message}`;
    }, opts);
  }

  document.getElementById('btnGeo').addEventListener('click', ()=>getGeo(false));
  document.getElementById('btnGeoHi').addEventListener('click', ()=>getGeo(true));
  document.getElementById('btnClear1').addEventListener('click', ()=>geoOut.textContent='');

  // ====== 概略位置（IPベース：2サービス比較） ======
  const ipOut = document.getElementById('ipOut');
  async function ipapi(){
    ipOut.textContent = 'ipapi.co から取得中…';
    try{
      const r = await fetch('https://ipapi.co/json/');
      const d = await r.json();
      ipOut.textContent =
`概略位置: OK (ipapi.co)
${d.city || '-'}, ${d.region || '-'}, ${d.country_name || '-'}
lat: ${d.latitude ?? '-'}, lng: ${d.longitude ?? '-'}
ISP/ORG: ${d.org || '-'}
注: IPデータベースの更新状況や拠点位置によりズレることがあります。`;
    }catch(e){
      ipOut.textContent = 'ipapi.co: 失敗\n' + e;
    }
  }
  async function ipwho(){
    ipOut.textContent = 'ipwho.is から取得中…';
    try{
      const r = await fetch('https://ipwho.is/');
      const d = await r.json();
      ipOut.textContent =
`概略位置: ${d.success ? 'OK' : '失敗'} (ipwho.is)
${(d.city||'-')}, ${(d.region||'-')}, ${(d.country||'-')}
lat: ${(d.latitude ?? '-')}, lng: ${(d.longitude ?? '-')}
ISP: ${(d.connection && d.connection.isp) ? d.connection.isp : '-'}
注: IP位置は拠点（例: 名古屋）の地点を返すことがあります。`;
    }catch(e){
      ipOut.textContent = 'ipwho.is: 失敗\n' + e;
    }
  }
  document.getElementById('btnIp1').addEventListener('click', ipapi);
  document.getElementById('btnIp2').addEventListener('click', ipwho);
  document.getElementById('btnClear2').addEventListener('click', ()=>ipOut.textContent='');
})();
</script>
</body>
</html>
