<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="referrer" content="no-referrer">
<title>あなたの環境（ローカル表示）</title>
<style>
  :root{ --bg:#0f1220; --panel:#171a2b; --text:#e8ecf3; --muted:#a9b0c3; --accent:#4dd0e1; }
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Roboto,"Noto Sans JP",Meiryo}
  .wrap{max-width:860px;margin:24px auto;padding:16px}
  h1{margin:0 0 12px;font-size:clamp(20px,5vw,28px)}
  .card{background:var(--panel);border-radius:16px;padding:16px 18px;box-shadow:0 12px 24px rgba(0,0,0,.35)}
  .row{display:grid;grid-template-columns:140px 1fr;gap:8px 12px;align-items:center}
  .row b{color:var(--muted);font-weight:600}
  .btn{margin-top:16px;border:none;border-radius:12px;padding:10px 14px;background:#2a2f52;color:#fff;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:wait}
  .note{color:var(--muted);font-size:.9rem;margin-top:10px}
  .ok{color:#a5d6a7} .warn{color:#ffb74d} .err{color:#ff6b6b}
  pre{white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
<div class="wrap">
  <h1>あなたの環境（この端末だけに表示）</h1>
  <div class="card">
    <div class="row"><b>言語</b><div id="lang">-</div></div>
    <div class="row"><b>タイムゾーン</b><div id="tz">-</div></div>
    <div class="row"><b>ユーザーエージェント</b><div id="ua" style="overflow-wrap:anywhere">-</div></div>
    <div class="row"><b>画面サイズ</b><div id="size">-</div></div>
    <hr style="border-color:rgba(255,255,255,.1)">
    <div class="row"><b>現在地（任意）</b>
      <div>
        <div id="geoStatus" class="warn">未取得（「位置情報を表示」を押して、ブラウザで許可）</div>
        <div id="latlon" style="margin-top:2px;color:#a9b0c3"></div>
        <div id="addr" style="margin-top:6px;font-weight:700"></div>
      </div>
    </div>
    <button id="btn" class="btn">位置情報を表示（任意）</button>
    <div class="note">
      ※ このページはサーバに何も送信しません。逆ジオコーディングのため、<code>geoapi.heartrails.com</code> に座標が送られ、その結果がこの画面にだけ表示されます。
    </div>
  </div>
</div>

<script>
  // 端末情報をローカル表示
  document.getElementById('lang').textContent = navigator.language || '-';
  document.getElementById('tz').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone || '-';
  document.getElementById('ua').textContent = navigator.userAgent || '-';
  document.getElementById('size').textContent = `${screen.width}×${screen.height}`;

  const btn = document.getElementById('btn');
  const geoStatus = document.getElementById('geoStatus');
  const latlon = document.getElementById('latlon');
  const addr = document.getElementById('addr');

  btn.addEventListener('click', () => {
    if(!('geolocation' in navigator)){
      geoStatus.textContent = 'このブラウザは位置情報に対応していません。';
      geoStatus.className = 'err'; return;
    }
    btn.disabled = true; geoStatus.textContent = '測位中…'; addr.textContent = ''; latlon.textContent = '';

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const { latitude: lat, longitude: lon } = pos.coords;
      latlon.textContent = `緯度 ${lat.toFixed(6)} / 経度 ${lon.toFixed(6)}`;
      geoStatus.textContent = '住所を取得中…';

      try {
        // HeartRails Geo API (prefecture / city / town を返す)
        const url = `https://geoapi.heartrails.com/api/json?method=searchByGeoLocation&x=${encodeURIComponent(lon)}&y=${encodeURIComponent(lat)}`;
        const res = await fetch(url, { referrerPolicy: 'no-referrer' });
        if(!res.ok) throw new Error('reverse geocoding failed');
        const data = await res.json();
        const loc = data?.response?.location?.[0];
        if(loc){
          // 県名 + 市区町村までを表示（町域はオプション）
          addr.textContent = `${loc.prefecture} ${loc.city}${loc.town ? '（'+loc.town+' 付近）' : ''}`;
          geoStatus.textContent = '取得完了';
          geoStatus.className = 'ok';
        }else{
          throw new Error('no location');
        }
      } catch (e) {
        geoStatus.textContent = '住所の取得に失敗しました（通信・権限・圏外など）';
        geoStatus.className = 'err';
      } finally {
        btn.disabled = false;
      }
    }, (err) => {
      btn.disabled = false;
      geoStatus.textContent = err.code === 1 ? 'ユーザーが位置共有を拒否しました' :
                              err.code === 2 ? '位置を特定できませんでした' :
                              '位置情報の取得に失敗しました';
      geoStatus.className = 'err';
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
  });
</script>
</body>
</html>
